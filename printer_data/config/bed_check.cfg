[gcode_macro _BED_STAB_CHECK]
gcode:
  CHECK_STABILITY_LOOP SENSOR=Bed2
  G4 P60000
  _CHECK_STABILITY_ITERATION
  

[gcode_macro CHECK_STABILITY_LOOP]
# Persistent variables
variable_initial_temp: 0.0
variable_sensor_id: 1 # Default: 1 = extruder
description: Stores the initial reference temperature and sensor ID for the stability check.
gcode:
    # 1. Get the simple SENSOR ID from the parameter (e.g., SENSOR=Bed2)
    {% set SENSOR_ID_STRING = params.SENSOR|default("extruder")|string %}
    
    # 2. --- Translate String ID to a Numerical ID ---
    {% set SENSOR_ID_NUM = 1 %} ; (Default to 1 = extruder)
    {% if SENSOR_ID_STRING == "Bed2" %}
        {% set SENSOR_ID_NUM = 2 %}
    {% elif SENSOR_ID_STRING == "heater_bed" %}
        {% set SENSOR_ID_NUM = 3 %}
    {% endif %}
    # ------------------------------------------------

    # 3. Store the NUMERICAL ID
    SET_GCODE_VARIABLE MACRO=CHECK_STABILITY_LOOP VARIABLE=sensor_id VALUE={SENSOR_ID_NUM}

    # 4. --- Translate Numerical ID back to Full Sensor Name (for this run) ---
    {% if SENSOR_ID_NUM == 2 %}
        {% set SENSOR_NAME = "temperature_sensor Bed2" %}
    {% elif SENSOR_ID_NUM == 3 %}
        {% set SENSOR_NAME = "heater_bed" %}
    {% else %}
        {% set SENSOR_NAME = "extruder" %}
    {% endif %}
    # -----------------------------------------------------------------

    M118 --- Waiting Bed Temp Stabilize ---
    
    # 5. Access the sensor value using the full Klipper object path
    {% set TEMP_READING = printer[SENSOR_NAME].temperature | round(2) %}
    SET_GCODE_VARIABLE MACRO=CHECK_STABILITY_LOOP VARIABLE=initial_temp VALUE={TEMP_READING}
    
    M118 Initial Reference Temp: {TEMP_READING}C
    
    
[gcode_macro _CHECK_STABILITY_ITERATION]
description: Internal macro that performs the reading, comparison, and looping logic.
gcode:
    # 1. Access stored variables (código omitido)
    {% set SENSOR_ID_NUM = printer["gcode_macro CHECK_STABILITY_LOOP"].sensor_id %}
    {% set PREVIOUS_TEMP = printer["gcode_macro CHECK_STABILITY_LOOP"].initial_temp | round(2) %}
    
    # 2. Translate Numerical ID back to Full Sensor Name (código omitido)
    {% if SENSOR_ID_NUM == 2 %}
        {% set SENSOR_NAME = "temperature_sensor Bed2" %}
    {% elif SENSOR_ID_NUM == 3 %}
        {% set SENSOR_NAME = "heater_bed" %}
    {% else %}
        {% set SENSOR_NAME = "extruder" %}
    {% endif %}
    
    # 3. Get the new temperature (Read 2)
    {% set CURRENT_TEMP = printer[SENSOR_NAME].temperature | round(2) %}
    
    # 4. Calculate the difference and stability threshold
    {% set DIFF = (CURRENT_TEMP - PREVIOUS_TEMP) | abs | round(2) %}
    {% set THRESHOLD = 0.1 %}
    
    M118 Current Temp: {CURRENT_TEMP}C | Previous Temp: {PREVIOUS_TEMP}C | Difference: {DIFF}C
    
    # 5. Check the condition
    {% if DIFF < THRESHOLD %}
        
        _CHECK_STABILITY_FINISH
        
    {% else %}
        
        M118 Stability not yet reached (Diff > {THRESHOLD}C). Waiting another 60s...
        
        SET_GCODE_VARIABLE MACRO=CHECK_STABILITY_LOOP VARIABLE=initial_temp VALUE={CURRENT_TEMP}
        
        # Agenda a execução do CHECK_STABILITY_DELAY (o delay de 30s)
        UPDATE_DELAYED_GCODE ID=CHECK_STABILITY_DELAY DURATION=60
        
    {% endif %}
  

[gcode_macro _CHECK_STABILITY_FINISH]
description: Internal macro called when the thermal stability condition is met.
gcode:
    UPDATE_DELAYED_GCODE ID=CHECK_STABILITY_DELAY DURATION=0
    
    M118 Bed Temp Stabilized!
    _START_PRINT2

[delayed_gcode CHECK_STABILITY_DELAY]
gcode:
    # Simplesmente chama a iteração. 
    # Se isso falhar, o firmware está ativamente bloqueando.
    _CHECK_STABILITY_ITERATION
    